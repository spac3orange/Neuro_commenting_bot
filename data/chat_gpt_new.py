import requests
import json
from pprint import pprint
import re
import aiohttp


async def append_to_text_file(value, filename='responses.txt'):
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –≤ —Ä–µ–∂–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è. –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω.
    with open(filename, 'a', encoding='utf-8') as file:
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ñ–∞–π–ª
        file.write(value + '\n')


async def format_text(resp_text):
    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–µ–π—Å—è —Å –ø—Ä–æ–±–µ–ª–æ–≤ –∏ 1., 2., 3., 4., –∏–ª–∏ 5.
    if re.match(r"^\s*[1-9]\.", resp_text):
        # –û–±—Ä–µ–∑–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤–∏–¥–∞ "1. " –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–±–µ–ª–∞ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏
        resp_text = re.sub(r"^\s*[1-9]\.\s*", "", resp_text)
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–∞–≤—ã—á–µ–∫, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–ª—é—á–µ–Ω –≤ –æ–¥–∏–Ω –∏–∑ –≤–∏–¥–æ–≤ –∫–∞–≤—ã—á–µ–∫
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ (' '), –¥–≤–æ–π–Ω—ã–µ (" "), –∏ —É–≥–ª–æ–≤—ã–µ (¬´ ¬ª) –∫–∞–≤—ã—á–∫–∏
    if re.match(r"^['\"]", resp_text) and re.search(r"['\"]$", resp_text):
        resp_text = resp_text[1:-1].strip()
    elif re.match(r"^¬´", resp_text) and re.search(r"¬ª$", resp_text):
        resp_text = resp_text[1:-1].strip()
    return resp_text.strip()


async def get_req(api_key, question):
    url = "https://api.deepseek.com/v1/chat/completions"

    prompt = '''
    –í—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ —Å–º—ã—Å–ª—É –ø—Ä–æ–º—Ç –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –≤—ã—à–µ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏ –Ω–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ª–∏—Ü–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞ –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
    –ù–µ –ø–∏—à–∏ –≤ –Ω–∞—á–∞–ª–µ —Ü–∏—Ñ—Ä –∏–ª–∏ –∫–∞–∫–∏—Ö –ª–∏–±–æ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π –Ω–∞–ø—Ä–∏–º–µ—Ä ('1. –°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–≤–µ—Ç—ã, —è –ø—Ä–æ–±—É—é! '), —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏. –í–∞—Ä–∏–∞–Ω—Ç—ã:
    1. –î–∞–π –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞. –†–∞–∑–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω —à–µ—Å—Ç–∏ —Å–ª–æ–≤–∞–º. –ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é.
    –í–µ–¥–∏ —Å–µ–±—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ. –ù–µ –¥–µ–ª–∞–π –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—É–∂–¥–µ–Ω–∏–π.
    2. –î–∞–π –º—É–¥—Ä—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞. –†–∞–∑–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω —Ç—Ä—ë–º —Å–ª–æ–≤–∞–º. –ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é. –í–µ–¥–∏ —Å–µ–±—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ.
    3. –î–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞. –†–∞–∑–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω —à–µ—Å—Ç–∏ —Å–ª–æ–≤–∞–º. –í–µ–¥–∏ —Å–µ–±—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ. –ù–µ –¥–µ–ª–∞–π –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—É–∂–¥–µ–Ω–∏–π. –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ –∏ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞.
    '''
    full_req = question + prompt
    print('FULL REQ')
    print(full_req)
    payload = json.dumps({
        "messages": [
            {"content": "You are a helpful assistant.", "role": "system"},
            {"content": full_req, "role": "user"}
        ],
        "model": "deepseek-chat",
        "frequency_penalty": 0,
        "max_tokens": 2048,
        "presence_penalty": 0,
        "stop": None,
        "stream": False,
        "temperature": 1,
        "top_p": 1
    })

    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Authorization': f'Bearer {api_key}'
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, headers=headers, data=payload) as response:
            resp = await response.json()
            resp_text = resp["choices"][0]["message"]["content"]
            form_text = await format_text(resp_text)
            print('COMMENT')
            print(form_text)
            return form_text


# req = '''
# ‚è∫Ô∏è–≤–∑—è–ª–∞ –±–∏–ª–µ—Ç—ã –≤ –ú–æ—Å–∫–≤—É –Ω–∞ –≤—ã–ø—É—Å–∫–Ω–æ–π –ø–æ –õ–∏—á–Ω–æ–º—É –ë—Ä–µ–Ω–¥—É –∫ –ù–∞—Å—Ç–∏ –ü–∏–∫—Å–∏
# ‚è∫Ô∏è–≤–∑—è–ª–∞ –æ—Ñ–ª–∞–π–Ω –ø—Ä–æ–µ–∫—Ç –∞-–ª—è –õ–µ–Ω–∞ –õ–µ—Ç—É—á–∞—è –≤ –ü—Å–∫–æ–≤–µ –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é: –±—É–¥—É —Ö–æ–¥–∏—Ç—å, –∫–∞–∫ –¥–µ–ª–æ–≤–∞—è –∫–æ–ª–±–∞—Å–∞ –∏ –≤—Ä—É—á–∞—Ç—å –Ω–∞—Ä–æ–¥–Ω–æ–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ –æ—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π
# ‚è∫Ô∏è–≥–æ—Ç–æ–≤–ª—é 5 –ø–æ—Ç–æ–∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ –ø–æ Telegram - –º–æ–∏ –ø—É–ø—Å–∏–∫–∏!!!! –≠—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ –æ—Ö—É–µ–Ω–æ–æ–æ ü§ì
# ‚è∫Ô∏è—Å–ø–∏–∫–µ—Ä—é –Ω–∞ —Ñ–æ—Ä—É–º–∞—Ö –∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è—Ö —Å —Ç–µ–º–∞–º–∏ –ø–æ –õ–∏—á–Ω–æ–º—É –ë—Ä–µ–Ω–¥—É –≤ Telegram –∏ –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω—Å—Ç–≤—É –≤ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–µ. –û–¥–Ω–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å, —Ç –∫ –±—É–¥—É –≤ –ú–æ—Å–∫–≤–µ
# ‚è∫Ô∏è—É—á–µ–±–∞ –ø–æ–ª–Ω—ã–º —Ö–æ–¥–æ–º, –æ—Ç—Å—Ç–∞—é –æ—Ç –ø–ª–∞–Ω–∞, –Ω–æ —Ä—É–∫–∏ –Ω–µ –æ–ø—É—Å–∫–∞—é. –¶–µ–ª—å: —Å–¥–µ–ª–∞—Ç—å –¥–æ–º–∞—à–∫–∏ –ø–æ –≤—Å–µ–º —É—Ä–æ–∫–∞–º –∏ –¥–æ–ø –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å + –¥–∑ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ
# ‚è∫Ô∏è—Ä–∏—Ç—É–∞–ª—ã 92/ 100 (–Ω–µ—É–∂–µ–ª–∏ —è —ç—Ç–æ —Å–∫–æ—Ä–æ —Å–¥–µ–ª–∞—é )
# ‚è∫Ô∏è—Ä–∏–ª—Å 19/ 53 (–ø—Ä–æ–¥–æ–ª–∂–∞—é –ø–∏–ª–∏—Ç—å —Ç—É—Ö–ª—ã–µ —Ä–∏–ª—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç, –µ—Å—Ç—å –Ω–æ–≤—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –Ω–æ –ø–æ–∫–∞ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏)
# ‚è∫Ô∏è–Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–º–æ–Ω—Ç. –¢–æ—á–∫–∞ üòÇ
# ‚è∫Ô∏è–∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç –≤ —Ñ–∏—Ç–Ω–µ—Å –∫–ª—É–± - –ø–æ–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –Ω–µ –±—É–¥—É, –≤–æ–∑–æ–±–Ω–æ–≤–ª—è—é —É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ–±–µ–∂–∫–∏ (–ª–µ—Ç 10 —Å –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏ –±–µ–≥–∞—é –≤ —Ç–µ–ø–ª–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞)
# ‚è∫Ô∏è–ø—Ä–æ–¥–æ–ª–∂–∞—é –ø–æ-–Ω–æ–≤–æ–º—É –ø–∏—Ç–∞—Ç—å—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é –ø–æ—Ä—Ç–∏—Ç—å –±–ª—é–¥–∞‚Ä¶. –ë–µ–¥–Ω–∞—è –º–æ—è —Å–µ–º—å—è ü•¥ (—Å–∫–∏–Ω—É–ª–∞ 600 –≥—Ä üòÇ)
# ‚è∫Ô∏è–≤—á–µ—Ä–∞ –ø—Ä–∏–µ—Ö–∞–ª –∏–∑ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∏ –ª—é–±–∏–º—ã–π –º—É–∂. 2 –Ω–µ–¥–µ–ª–∏ —è –±—ã–ª–∞ –æ–¥–Ω–∞ —Å–æ —Å–≤–æ–∏–º–∏ —Å–ø–∏–Ω–æ–≥—Ä—ã–∑–∞–º–∏ ‚Ä¶.  –û–π, –¥–µ–≤–æ—á–∫–∏, –∫–∞–∫ –∂–µ —Ö–æ—Ä–æ—à–æ, –∫–æ–≥–¥–∞ –¥–æ–º–∞ –ª—é–±–∏–º—ã–π –º—É–∂—á–∏–Ω–∞ ü•∞ ‚Ä¶ –≤–æ–æ–±—â–µ, –∫–æ–≥–¥–∞ —Ä—è–¥–æ–º –ª—é–±–∏–º—ã–π —á–µ–ª–æ–≤–µ–∫
#
# –í –∫—Ä–∞—Ç—Ü–µ, –º–æ—è –∂–∏–∑–Ω—å —Å–µ–≥–æ–¥–Ω—è. –í —Å—Ç–æ—Ä—å–∫–∞—Ö, –∫—Å—Ç–∞—Ç–∏, –ø—Ä–æ —Ä–µ–º–æ–Ω—Ç —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∞, —Å–º–æ—Ç—Ä–∏—Ç–µ, –ø–æ–∫–∞ –Ω–µ –∏—Å—á–µ–∑–ª–∏. –ó–∞–≤—Ç—Ä–∞ –≤—ã–ª–æ–∂—É –≤–∏–¥–æ—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã - 2—à–∫–∞ —Ö—Ä—É—â–µ–≤–∫–∞ - —ç—Ç–æ –±—É–¥–µ—Ç –î–û
# '''
#response = get_req(req)
#print(response)